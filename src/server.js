// src/server.js

import 'dotenv/config'; 
import express from 'express';
import path from 'path';
import { fileURLToPath } from 'url';
import cors from 'cors'; // CORS ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
import mongoose from 'mongoose'; // MongoDB ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

// ESM (ECMAScript Module) ‡¶è __dirname ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();

// .env ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá PORT ‡¶è‡¶¨‡¶Ç MONGO_URI ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
// Render-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü 10000 ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶≠‡¶æ‡¶≤‡ßã
const PORT = process.env.PORT || 10000;
const MONGO_URI = process.env.MONGO_URI; 

// =======================================================
// üåê ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó (Mongoose)
// =======================================================
if (!MONGO_URI) {
    console.error("üî¥ Error: MONGO_URI is not defined in environment variables!");
} else {
    mongoose.connect(MONGO_URI)
        .then(() => {
            console.log("‚úÖ MongoDB connected successfully!");
        })
        .catch(err => {
            console.error("‚ùå MongoDB connection error:", err.message);
            // ‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º, ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ó ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá‡•§
        });
}

// =======================================================
// ‚öôÔ∏è ‡¶Æ‡¶ø‡¶°‡¶≤‡¶ì‡¶Ø‡¶º‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶®
// =======================================================

// üí° CORS ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ: ‡¶è‡¶ü‡¶ø login(pending) ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡•§
// ‡¶∏‡¶¨ ‡¶Ö‡¶∞‡¶ø‡¶ú‡¶ø‡¶®‡¶ï‡ßá ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø:
app.use(cors()); 

// ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ‡¶ø‡¶Ç JSON ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
app.use(express.json()); 
// ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ‡¶ø‡¶Ç URL-encoded ‡¶°‡ßá‡¶ü‡¶æ (‡¶´‡¶∞‡ßç‡¶Æ ‡¶°‡ßá‡¶ü‡¶æ) ‡¶™‡¶æ‡¶∞‡ßç‡¶∏ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
app.use(express.urlencoded({ extended: true }));


// =======================================================
// üîê ‡¶è‡¶™‡¶ø‡¶Ü‡¶á ‡¶∞‡ßÅ‡¶ü‡¶ø‡¶Ç (API Routing)
// =======================================================

// ‡¶°‡¶æ‡¶Æ‡¶ø ‡¶≤‡¶ó‡¶á‡¶® ‡¶∞‡ßÅ‡¶ü (‡¶è‡¶ñ‡¶® MongoDB ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶§‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá)
app.post('/api/login', (req, res) => {
    // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶™‡ßç‡¶∞‡¶ï‡ßÉ‡¶§ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á‡¶ï‡¶∞‡¶£ ‡¶≤‡¶ú‡¶ø‡¶ï ‡¶Ø‡¶æ‡¶¨‡ßá
    const { email, password } = req.body; 

    // ‡¶Ø‡ßá‡¶π‡ßá‡¶§‡ßÅ Mongoose ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶â‡¶™‡¶∞‡ßá ‡¶Ü‡¶õ‡ßá, ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶æ‡¶®‡ßá Mongoose ‡¶Æ‡¶°‡ßá‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®
    // ‡¶è‡¶ñ‡¶® ‡¶°‡¶æ‡¶Æ‡¶ø ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶¶‡¶ø‡¶ö‡ßç‡¶õ‡¶ø:
    if (email && password) {
        return res.status(200).json({ 
            success: true, 
            message: "Login request received and processed.",
            user: { email: email, name: "Test User" }
        });
    } else {
        return res.status(400).json({ 
            success: false, 
            message: "Email and password are required." 
        });
    }
});


// ‡¶°‡¶æ‡¶Æ‡¶ø ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶∞‡ßÅ‡¶ü
app.get('/api/posts', (req, res) => {
    // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá MongoDB ‡¶•‡ßá‡¶ï‡ßá ‡¶°‡ßá‡¶ü‡¶æ ‡¶´‡ßá‡¶ö ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ï‡ßã‡¶° ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
    return res.status(200).json({ 
        posts: [
            { id: 1, user: 'shakib001', text: 'Render deployment successful!' },
            { id: 2, user: 'test_user', text: 'CORS and DB issue fixed.' }
        ]
    });
});


// =======================================================
// üåê ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶ø‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶∞‡ßÅ‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç
// =======================================================

// ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡ßç‡¶∞‡¶®‡ßç‡¶ü‡¶è‡¶®‡ßç‡¶° 'public' ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßá
app.use(express.static(path.join(__dirname, "public")));

// ‡¶∞‡ßÅ‡¶ü ‡¶™‡ßá‡¶ú
app.get("/", (req, res) => {
    // ‡¶è‡¶ü‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡ßç‡¶∞‡¶®‡ßç‡¶ü‡¶è‡¶®‡ßç‡¶° ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶¨‡ßá (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá)
    res.sendFile(path.join(__dirname, "public", "index.html"));
});


// =======================================================
// üöÄ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶ø‡¶Ç
// =======================================================

app.listen(PORT, '0.0.0.0', () => { // Render-‡¶è 0.0.0.0 ‡¶¨‡¶æ‡¶á‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï
    console.log(`‚úÖ Server running on port ${PORT}`);
});